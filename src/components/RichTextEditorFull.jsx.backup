// src/components/RichTextEditorFull.jsx
import React, { useMemo, useRef } from 'react';
import ReactQuill, { Quill } from 'react-quill-new';
import ImageResize from 'quill-image-resize-module-react';
import 'react-quill-new/dist/quill.snow.css';
import './RichTextEditor.css';
'dancing-script',
    'lobster',
    'permanent-marker',
    'shadows-into-light'
];
Quill.register(Font, true);


// Configurar tamaños personalizados (de 6px a 200px)
const Size = Quill.import('attributors/style/size');
const sizeArr = [];
for (let i = 6; i <= 200; i++) {
    sizeArr.push(i + 'px');
}
Size.whitelist = sizeArr;
Quill.register(Size, true);

/**
 * Editor completo estilo Google Docs con toolbar en una sola fila
 */
export default function RichTextEditorFull({
    value,
    onChange,
    placeholder = "Escribe aquí...",
    readOnly = false,
    toolbar = 'full'
}) {
    const quillRef = useRef(null);


    // Funciones para cambiar tamaño de fuente (SIN LÍMITES)
    const decreaseFontSize = () => {
        const quill = quillRef.current?.getEditor();
        if (quill) {
            const format = quill.getFormat();
            let currentSize = format.size || '14px';

            // Convertir a número
            let sizeNum = parseInt(currentSize);
            if (isNaN(sizeNum)) sizeNum = 14; // Default

            // Decrementar (mínimo 6px para ser legible)
            sizeNum = Math.max(6, sizeNum - 1);

            // Aplicar y actualizar display
            const newSize = sizeNum + 'px';
            quill.format('size', newSize);
            updateFontSizeDisplay(sizeNum);
        }
    };

    const increaseFontSize = () => {
        const quill = quillRef.current?.getEditor();
        if (quill) {
            const format = quill.getFormat();
            let currentSize = format.size || '14px';

            // Convertir a número
            let sizeNum = parseInt(currentSize);
            if (isNaN(sizeNum)) sizeNum = 14; // Default

            // Incrementar (sin límite superior)
            sizeNum = sizeNum + 1;

            // Aplicar y actualizar display
            const newSize = sizeNum + 'px';
            quill.format('size', newSize);
            updateFontSizeDisplay(sizeNum);
        }
    };

    // Función para actualizar el input del tamaño
    const updateFontSizeDisplay = (size) => {
        const input = document.querySelector('.font-size-input');
        if (input) {
            input.value = size;
        }
    };

    // Handler para insertar imágenes con soporte Google Drive
    const imageHandler = () => {
        const url = prompt('Ingresa la URL de la imagen:');
        if (url) {
            let finalUrl = url;
            if (url.includes('drive.google.com')) {
                let fileId = null;
                const match1 = url.match(/\/file\/d\/([^\/\?]+)/);
                if (match1) fileId = match1[1];
                const match2 = url.match(/[?\&]id=([^\&]+)/);
                if (!fileId && match2) fileId = match2[1];
                if (fileId) finalUrl = `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            const quill = quillRef.current?.getEditor();
            if (quill) {
                const range = quill.getSelection(true);
                quill.insertEmbed(range.index, 'image', finalUrl);
                quill.setSelection(range.index + 1);
            }
        }
    };

    // Toolbar en UNA SOLA FILA (igual a Google Docs)
    const toolbarConfig = useMemo(() => {
        if (toolbar === 'minimal') {
            return [[
                'bold', 'italic', 'underline',
                { 'color': [] },
                { 'align': [] }
            ]];
        }

        if (toolbar === 'basic') {
            return [[
                { 'header': [1, 2, 3, false] },
                'bold', 'italic', 'underline',
                { 'color': [] }, { 'background': [] },
                { 'align': [] },
                { 'list': 'ordered' }, { 'list': 'bullet' },
                'link', 'image'
            ]];
        }

        // FULL: Exactamente como Google Docs - en este orden
        return [[
            { 'header': [1, 2, 3, 4, 5, 6, false] },  // Estilos de texto
            { 'font': [] },                            // Fuente
            { 'size': [] },                            // Tamaño
            'bold',                                    // Negrita
            'italic',                                  // Cursiva  
            'underline',                               // Subrayado
            { 'color': [] },                           // Color de texto
            { 'background': [] },                      // Color de resaltado
            'link',                                    // Enlace
            'image',                                   // Insertar imagen
            { 'align': [] },                           // Alineación
            { 'list': 'ordered' },                     // Lista numerada
            { 'list': 'bullet' },                      // Lista con viñetas
            { 'indent': '-1' },                        // Disminuir sangría
            { 'indent': '+1' },                        // Aumentar sangría
            'clean'                                    // Borrar formato
        ]];
    }, [toolbar]);

    // Configuración de módulos
    const modules = useMemo(() => ({
        toolbar: {
            container: toolbarConfig,
            handlers: {
                image: imageHandler
            }
        },
        imageResize: {
            parchment: Quill.import('parchment'),
            modules: ['Resize', 'DisplaySize'],
            handleStyles: {
                backgroundColor: '#1890ff',
                border: '1px solid white',
                borderRadius: '50%',
                width: '8px',
                height: '8px'
            }
        },
        clipboard: {
            matchVisual: false
        },
        history: {
            delay: 1000,
            maxStack: 100,
            userOnly: true
        }
    }), [toolbarConfig]);

    // Formatos soportados
    const formats = [
        'header', 'font', 'size',
        'bold', 'italic', 'underline',
        'color', 'background',
        'list', 'bullet', 'indent',
        'align',
        'link', 'image'
    ];

    // Insertar botones custom al inicio del toolbar de Quill
    React.useEffect(() => {
        const toolbar = document.querySelector('.ql-toolbar.ql-snow');
        if (!toolbar) return;

        // Verificar si ya se insertaron los botones
        if (toolbar.querySelector('.custom-toolbar-btns')) return;

        // Crear contenedor para botones custom
        const customBtnsContainer = document.createElement('span');
        customBtnsContainer.className = 'custom-toolbar-btns';
        customBtnsContainer.style.cssText = 'display: inline-flex; align-items: center; gap: 2px; margin-right: 8px;';

        // 1. Botón Buscar (PRIMERO según Google Docs)
        const searchBtn = document.createElement('button');
        searchBtn.className = 'custom-toolbar-btn';
        searchBtn.title = 'Buscar (Ctrl+F)';
        searchBtn.type = 'button';
        searchBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18"><circle cx="7" cy="7" r="4.5" stroke="currentColor" stroke-width="1.5" fill="none"/><path d="M10 10L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';
        searchBtn.onclick = () => {
            const searchText = prompt('¿Qué deseas buscar?');
            if (searchText) {
                window.find(searchText);
            }
        };

        // 2. Botón Deshacer
        const undoBtn = document.createElement('button');
        undoBtn.className = 'custom-toolbar-btn';
        undoBtn.title = 'Deshacer (Ctrl+Z)';
        undoBtn.type = 'button';
        undoBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18"><path d="M8.5 3L3 8.5L8.5 14M3 8.5H15" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>';
        undoBtn.onclick = () => quillRef.current?.getEditor().history.undo();

        // 3. Botón Rehacer
        const redoBtn = document.createElement('button');
        redoBtn.className = 'custom-toolbar-btn';
        redoBtn.title = 'Rehacer (Ctrl+Y)';
        redoBtn.type = 'button';
        redoBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18"><path d="M9.5 3L15 8.5L9.5 14M15 8.5H3" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>';
        redoBtn.onclick = () => quillRef.current?.getEditor().history.redo();

        // 4. Botón Imprimir
        const printBtn = document.createElement('button');
        printBtn.className = 'custom-toolbar-btn';
        printBtn.title = 'Imprimir (Ctrl+P)';
        printBtn.type = 'button';
        printBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18"><rect x="3" y="2" width="12" height="4" stroke="currentColor" stroke-width="1.5" fill="none"/><rect x="2" y="6" width="14" height="7" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/><rect x="4" y="11" width="10" height="5" fill="white" stroke="currentColor" stroke-width="1.5"/></svg>';
        printBtn.onclick = () => window.print();

        // 5. Botón Copiar formato (Format Painter)
        const formatPainterBtn = document.createElement('button');
        formatPainterBtn.className = 'custom-toolbar-btn';
        formatPainterBtn.title = 'Copiar formato';
        formatPainterBtn.type = 'button';
        formatPainterBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 18 18"><rect x="4" y="3" width="10" height="3" fill="currentColor"/><rect x="7" y="6" width="4" height="9" fill="currentColor"/><rect x="5" y="13" width="8" height="2" fill="currentColor"/></svg>';
        formatPainterBtn.onclick = () => {
            alert('Copiar formato: Selecciona el texto con el formato que deseas copiar, luego selecciona el texto destino.');
        };

        // 6. Botón Zoom
        const zoomBtn = document.createElement('button');
        zoomBtn.className = 'custom-toolbar-btn custom-toolbar-zoom';
        zoomBtn.title = 'Zoom';
        zoomBtn.type = 'button';
        zoomBtn.innerHTML = '<span style="font-size: 11px; font-weight: 500;">100%</span>';
        zoomBtn.onclick = () => {
            alert('Zoom: Esta funcionalidad requiere implementación personalizada.');
        };

        // Separador principal
        const mainSeparator = document.createElement('span');
        mainSeparator.className = 'toolbar-separator';

        // Agregar todos los botones al contenedor EN EL ORDEN CORRECTO
        customBtnsContainer.appendChild(searchBtn);
        customBtnsContainer.appendChild(undoBtn);
        customBtnsContainer.appendChild(redoBtn);
        customBtnsContainer.appendChild(printBtn);
        customBtnsContainer.appendChild(formatPainterBtn);
        customBtnsContainer.appendChild(zoomBtn);
        customBtnsContainer.appendChild(mainSeparator);

        // Insertar al inicio del toolbar
        toolbar.insertBefore(customBtnsContainer, toolbar.firstChild);

        // Ahora insertar los controles de tamaño ANTES del primer grupo de Quill
        const firstGroup = toolbar.querySelector('.ql-formats');
        if (firstGroup) {
            const sizeControls = document.createElement('span');
            sizeControls.className = 'ql-formats custom-size-controls';

            // Botón reducir
            const decreaseBtn = document.createElement('button');
            decreaseBtn.className = 'ql-size-decrease custom-toolbar-btn';
            decreaseBtn.title = 'Reducir tamaño de fuente';
            decreaseBtn.type = 'button';
            decreaseBtn.innerHTML = '<span style="font-size: 16px; font-weight: bold;">−</span>';
            decreaseBtn.onclick = decreaseFontSize;

            // Input editable del tamaño actual
            const sizeInput = document.createElement('input');
            sizeInput.type = 'number';
            sizeInput.className = 'font-size-input';
            sizeInput.value = '14';
            sizeInput.min = '6';
            sizeInput.max = '200';
            sizeInput.style.cssText = 'width: 45px; padding: 2px 4px; font-size: 13px; color: #444; border: 1px solid #d9d9d9; border-radius: 2px; text-align: center; outline: none;';

            // Evento para cambiar el tamaño al escribir
            sizeInput.addEventListener('change', () => {
                const quill = quillRef.current?.getEditor();
                if (quill) {
                    let newSize = parseInt(sizeInput.value);
                    // Validar límites
                    if (isNaN(newSize) || newSize < 6) newSize = 6;
                    if (newSize > 200) newSize = 200;

                    sizeInput.value = newSize;
                    quill.format('size', newSize + 'px');
                }
            });

            // Evento para aplicar al presionar Enter
            sizeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sizeInput.blur(); // Esto disparará el evento 'change'
                }
            });

            // Botón aumentar
            const increaseBtn = document.createElement('button');
            increaseBtn.className = 'ql-size-increase custom-toolbar-btn';
            increaseBtn.title = 'Aumentar tamaño de fuente';
            increaseBtn.type = 'button';
            increaseBtn.innerHTML = '<span style="font-size: 16px; font-weight: bold;">+</span>';
            increaseBtn.onclick = increaseFontSize;

            sizeControls.appendChild(decreaseBtn);
            sizeControls.appendChild(sizeInput);
            sizeControls.appendChild(increaseBtn);

            // Insertar después del dropdown de fuente
            const fontPicker = toolbar.querySelector('.ql-font');
            if (fontPicker && fontPicker.parentElement) {
                fontPicker.parentElement.insertAdjacentElement('afterend', sizeControls);
            }
        }

        // Agregar tooltips a los controles de Quill
        setTimeout(() => {
            const tooltips = {
                '.ql-header .ql-picker-label': 'Estilos de texto',
                '.ql-font .ql-picker-label': 'Fuente',
                '.ql-size .ql-picker-label': 'Tamaño de fuente',
                '.ql-bold': 'Negrita (Ctrl+B)',
                '.ql-italic': 'Cursiva (Ctrl+I)',
                '.ql-underline': 'Subrayado (Ctrl+U)',
                '.ql-color .ql-picker-label': 'Color de texto',
                '.ql-background .ql-picker-label': 'Color de resaltado',
                '.ql-link': 'Insertar enlace (Ctrl+K)',
                '.ql-image': 'Insertar imagen',
                '.ql-align .ql-picker-label': 'Alineación',
                '.ql-list[value="ordered"]': 'Lista numerada',
                '.ql-list[value="bullet"]': 'Lista con viñetas',
                '.ql-indent[value="-1"]': 'Disminuir sangría',
                '.ql-indent[value="+1"]': 'Aumentar sangría',
                '.ql-clean': 'Borrar formato'
            };

            Object.entries(tooltips).forEach(([selector, title]) => {
                const elements = toolbar.querySelectorAll(selector);
                elements.forEach(el => {
                    if (!el.title) el.title = title;
                });
            });
        }, 100);
    }, []);

    return (
        <div className="rich-text-editor-wrapper">
            <ReactQuill
                ref={quillRef}
                theme="snow"
                value={value}
                onChange={onChange}
                modules={modules}
                formats={formats}
                placeholder={placeholder}
                readOnly={readOnly}
            />
        </div>
    );
}
